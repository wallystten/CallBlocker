package com.seupacote.callblocker.ui

import android.Manifest
import android.app.role.RoleManager
import android.content.Intent
import android.content.pm.PackageManager
import android.os.Build
import android.os.Bundle
import android.provider.Settings
import android.widget.Button
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.seupacote.callblocker.R

class MainActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        val txtContactsStatus = findViewById<TextView>(R.id.txtContactsStatus)
        val txtCallFilterStatus = findViewById<TextView>(R.id.txtCallFilterStatus)
        val txtBatteryStatus = findViewById<TextView>(R.id.txtBatteryStatus)

        val btnContacts = findViewById<Button>(R.id.btnContacts)
        val btnCallFilter = findViewById<Button>(R.id.btnCallFilter)
        val btnBattery = findViewById<Button>(R.id.btnBattery)

        // üîÑ Atualiza status ao abrir
        updateContactsStatus(txtContactsStatus)
        updateCallFilterStatus(txtCallFilterStatus)
        updateBatteryStatus(txtBatteryStatus)

        // üîê Permiss√£o de contatos
        btnContacts.setOnClickListener {
            requestContactsPermission()
        }

        // üìû Ativar filtro de chamadas
        btnCallFilter.setOnClickListener {
            openCallScreeningSelector()
        }

        // üîã Ajustar bateria
        btnBattery.setOnClickListener {
            openBatterySettings()
        }
    }

    // ================= STATUS =================

    private fun updateContactsStatus(textView: TextView) {
        val granted = ContextCompat.checkSelfPermission(
            this,
            Manifest.permission.READ_CONTACTS
        ) == PackageManager.PERMISSION_GRANTED

        textView.text = if (granted) {
            "‚úÖ Acesso aos contatos concedido"
        } else {
            "‚ùå Acesso aos contatos"
        }
    }

    private fun updateCallFilterStatus(textView: TextView) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            val roleManager = getSystemService(RoleManager::class.java)
            val active = roleManager.isRoleHeld(RoleManager.ROLE_CALL_SCREENING)

            textView.text = if (active) {
                "‚úÖ Filtro de chamadas ativo"
            } else {
                "‚ö†Ô∏è Filtro de chamadas n√£o ativado"
            }
        } else {
            textView.text = "‚ö†Ô∏è Filtro de chamadas n√£o suportado"
        }
    }

    private fun updateBatteryStatus(textView: TextView) {
        textView.text = "‚ö†Ô∏è Otimiza√ß√£o de bateria pode interferir"
    }

    // ================= A√á√ïES =================

    private fun requestContactsPermission() {
        if (ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.READ_CONTACTS
            ) != PackageManager.PERMISSION_GRANTED
        ) {
            ActivityCompat.requestPermissions(
                this,
                arrayOf(Manifest.permission.READ_CONTACTS),
                1001
            )
        } else {
            Toast.makeText(this, "Permiss√£o j√° concedida", Toast.LENGTH_SHORT).show()
        }
    }

    private fun openCallScreeningSelector() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            val roleManager = getSystemService(RoleManager::class.java)

            if (!roleManager.isRoleHeld(RoleManager.ROLE_CALL_SCREENING)) {
                val intent = roleManager.createRequestRoleIntent(
                    RoleManager.ROLE_CALL_SCREENING
                )
                startActivity(intent)
            } else {
                Toast.makeText(
                    this,
                    "Call Blocker j√° est√° ativo como filtro",
                    Toast.LENGTH_SHORT
                ).show()
            }
        }
    }

    private fun openBatterySettings() {
        startActivity(
            Intent(Settings.ACTION_IGNORE_BATTERY_OPTIMIZATION_SETTINGS)
        )
    }

    // ================= CALLBACK =================

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        if (requestCode == 1001) {
            val txtContactsStatus = findViewById<TextView>(R.id.txtContactsStatus)
            updateContactsStatus(txtContactsStatus)
        }
    }
}
